# Game Haven v2 - Simplified Stack
# 3 containers: App + API + PostgreSQL
# Database schema auto-initializes on first boot

services:
  # ===================
  # PostgreSQL Database
  # ===================
  db:
    image: postgres:16-alpine
    container_name: gamehaven-db-v2
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: gamehaven
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./migrations-v2:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d gamehaven"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ===================
  # Express API Server
  # ===================
  api:
    build:
      context: ../../server
      dockerfile: ../deploy/standalone/Dockerfile.api
    container_name: gamehaven-api-v2
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@db:5432/gamehaven
      JWT_SECRET: ${JWT_SECRET}
      SITE_NAME: ${SITE_NAME:-Game Haven}
      SITE_URL: ${SITE_URL:-http://localhost:3000}
      CORS_ORIGINS: ${SITE_URL:-http://localhost:3000}
      AI_PROVIDER: ${AI_PROVIDER:-}
      AI_API_KEY: ${AI_API_KEY:-}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-}
      TURNSTILE_SECRET_KEY: ${TURNSTILE_SECRET_KEY:-}
      PII_ENCRYPTION_KEY: ${PII_ENCRYPTION_KEY:-}
      FEATURE_PLAY_LOGS: ${FEATURE_PLAY_LOGS:-true}
      FEATURE_WISHLIST: ${FEATURE_WISHLIST:-true}
      FEATURE_FOR_SALE: ${FEATURE_FOR_SALE:-true}
      FEATURE_MESSAGING: ${FEATURE_MESSAGING:-true}
      FEATURE_RATINGS: ${FEATURE_RATINGS:-true}
    ports:
      - "${API_PORT:-3001}:3001"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===================
  # Frontend (Nginx)
  # ===================
  app:
    build:
      context: ../..
      dockerfile: deploy/standalone/Dockerfile
    container_name: gamehaven-app-v2
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      SITE_NAME: ${SITE_NAME:-Game Haven}
      SITE_DESCRIPTION: ${SITE_DESCRIPTION:-Browse and discover our collection of board games}
      API_URL: http://api:3001
      FEATURE_PLAY_LOGS: ${FEATURE_PLAY_LOGS:-true}
      FEATURE_WISHLIST: ${FEATURE_WISHLIST:-true}
      FEATURE_FOR_SALE: ${FEATURE_FOR_SALE:-true}
      FEATURE_MESSAGING: ${FEATURE_MESSAGING:-true}
      FEATURE_DEMO_MODE: "false"
    ports:
      - "${APP_PORT:-3000}:80"

volumes:
  db_data:
