# Game Haven v1 - Full Supabase Stack (Legacy)

The v1 stack includes the complete Supabase platform for full feature parity with Lovable Cloud.

> ⚠️ **Note:** v1 is more complex to deploy and maintain. Consider [v2](./README-v2.md) for simpler setups.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     Your Linux Server                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Game Haven  │  │    Kong     │  │      PostgreSQL     │  │
│  │  Frontend   │──│  API Gateway│──│   + Auth + REST     │  │
│  │   :3000     │  │    :8000    │  │   + Realtime        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

**7+ containers** including GoTrue, PostgREST, Kong, Realtime, Edge Functions, and Studio.

---

## Quick Start

```bash
curl -fsSL https://get.docker.com | sh && \
git clone https://github.com/ThaneWinters/GameTavern.git && \
cd GameTavern/deploy/standalone && \
chmod +x install.sh scripts/*.sh && \
./install.sh
```

The installer will:
1. Prompt for site configuration
2. Generate secure secrets
3. Start all Docker services
4. Configure database passwords
5. Run migrations
6. Create your admin user
7. (Optional) Setup Nginx with SSL

---

## Services

| Service | Description | Port |
|---------|-------------|------|
| Game Haven | Frontend app | 3000 |
| PostgreSQL | Database | 5432 |
| GoTrue | Authentication | - |
| PostgREST | REST API | - |
| Kong | API Gateway | 8000 |
| Realtime | WebSockets | - |
| Studio | Database UI | 3001 |

---

## Configuration

### Core Settings

```bash
# .env
SITE_NAME=Game Haven
SITE_DESCRIPTION=Browse and discover our collection of board games
SITE_URL=http://localhost:3000
API_EXTERNAL_URL=http://localhost:8000
```

### Ports

```bash
APP_PORT=3000
STUDIO_PORT=3001
POSTGRES_PORT=5432
KONG_HTTP_PORT=8000
```

### Security (Auto-generated by installer)

```bash
POSTGRES_PASSWORD=...
JWT_SECRET=...
ANON_KEY=...
SERVICE_ROLE_KEY=...
```

### Features

```bash
FEATURE_PLAY_LOGS=true
FEATURE_WISHLIST=true
FEATURE_FOR_SALE=true
FEATURE_MESSAGING=true
FEATURE_COMING_SOON=true
FEATURE_DEMO_MODE=false
```

---

## Commands

```bash
# Start
docker compose up -d

# Stop
docker compose down

# Logs
docker compose logs -f

# Specific service logs
docker compose logs -f gamehaven

# Restart a service
docker compose restart gamehaven

# Rebuild
docker compose build --no-cache
docker compose up -d
```

---

## Administration

### Create Admin User

```bash
./scripts/create-admin.sh
```

### Access Supabase Studio

- **Direct:** `http://your-server-ip:3001`
- **Via Nginx:** `https://yourdomain.com/studio/`

### Backup

```bash
./scripts/backup.sh
```

### Restore

```bash
./scripts/restore.sh ./backups/gamehaven_20240101_120000.sql.gz
```

---

## Production Setup

### SSL with Nginx

```bash
./scripts/setup-nginx.sh
```

### Manual Nginx Config

```nginx
server {
    listen 443 ssl http2;
    server_name yourdomain.com;
    
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location /rest/ {
        proxy_pass http://127.0.0.1:8000/rest/;
        proxy_set_header Host $host;
    }
    
    location /auth/ {
        proxy_pass http://127.0.0.1:8000/auth/;
        proxy_set_header Host $host;
    }
    
    location /studio/ {
        proxy_pass http://127.0.0.1:3001/;
        proxy_set_header Host $host;
    }
}
```

---

## Troubleshooting

### Services not starting

```bash
./scripts/fix-db-passwords.sh
docker compose restart
```

### Auth service errors

```bash
docker logs gamehaven-auth --tail=50
docker logs gamehaven-kong --tail=50
```

### Database issues

```bash
# Check readiness
docker exec gamehaven-db pg_isready

# Test connection
docker exec gamehaven-db psql -U supabase_admin -d postgres -c "SELECT 1;"

# View logs
docker compose logs db
```

### Password authentication failed

```bash
./scripts/fix-db-passwords.sh
```

### Reset everything

```bash
docker compose down -v
./install.sh
```

---

## Uninstall

```bash
# Stop and remove
docker compose down -v

# Remove image
docker rmi standalone-gamehaven:latest

# Remove files
cd ~ && rm -rf ~/GameTavern

# Remove Nginx config
sudo rm -f /etc/nginx/sites-enabled/gamehaven
sudo systemctl reload nginx

# Clear Docker cache
docker builder prune -af
```

---

## Database Schema

The v1 stack uses the full Supabase schema with RLS policies:

- `games` - Game catalog
- `game_mechanics` - Game-to-mechanic mappings  
- `game_sessions` - Play history
- `game_wishlist` - User wishlists
- `game_messages` - Contact messages (encrypted)
- `game_ratings` - User ratings
- `site_settings` - Configuration
- `user_roles` - Admin permissions

All tables have Row Level Security enabled.

---

## Edge Functions

v1 includes Supabase Edge Functions:

| Function | Purpose |
|----------|---------|
| `bgg-lookup` | Search BoardGameGeek |
| `bgg-import` | Import game from BGG |
| `send-message` | Contact form |
| `rate-game` | Submit rating |
| `wishlist` | Wishlist management |
| `condense-descriptions` | AI summarization |

Functions are automatically deployed and routed through Kong at `/functions/v1/`.
